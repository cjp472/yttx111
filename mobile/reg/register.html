<!DOCreg html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width,initial-scale=1.0, user-scalable=no,maximum-scale=1.0,minimum-scale=1.0" />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="black" />
        <meta name="format-detection"content="telephone=no, email=no" />
        <!-- UC强制全屏 
        <meta name="full-screen" content="yes">-->
        <!-- QQ强制全屏 -->
        <meta name="x5-fullscreen" content="true">
        <title></title>
        <script type='text/javascript'>

            var _vds = _vds || [];
            window._vds = _vds;
            (function() {
                _vds.push(['setAccountId', 'b9c76468acc54288bfd0292976a2514d']);
                (function() {
                    var vds = document.createElement('script');
                    vds.type = 'text/javascript';
                    vds.async = true;
                    vds.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'dn-growing.qbox.me/vds.js';
                    var s = document.getElementsByTagName('script')[0];
                    s.parentNode.insertBefore(vds, s);
                })();
            })();
        </script>
        <script>
            var wid;
            if(window.location.search){
                if(window.location.search.substring(1).split('&')){
                    wid = window.location.search.substring(1).split('&')[0].split('=')[1];
                }
            }
        </script>
        <style reg="text/css">
            *{padding: 0;margin: 0;}
            html{
                height: 100%;font-size: 62.5%;
            }
            body{
                height: 100%;
                background: #FFFFFF; 
                color:#525252;
                font-size: 1.4rem;
                font: 1.4rem/2.8rem Microsoft YaHei,SimSun,Arial;
                overflow: hidden;
            }
            em{font-style: normal;}
            .clearfix:after{content:'\0020';display:block;height:0;clear:both;visibility:hidden;}
            .float-left{float: left;}
            .float-right{float: right;}
            .layer{
                position: absolute;
                width: 100%;
                top: 0;
                left: 100%;
                bottom: 0;
                background: rgba(0,0,0,.5);
                z-index: 100;
                -webkit-transition: -webkit-transform .45s;
                transition: transform .45s;
                /*-webkit-transform: translateX(100%);
                transform: translateX(100%);*/
            }
            .layer > div{
                width: 80%;
                height: 100%;
                margin-left: 20%;
                background-color: #FFFFFF;
                
            }
            .layer > div > h4{
                text-align: center;
                line-height: 5rem;
                font-size: 1.8rem;
                padding: 0 4%;
                border-bottom: 1px solid #EDE6E6;
                color: rgb(187, 168, 168);
                font-weight: normal;
            }
            .layer > div > div ul > li{
                padding: 0 4%;
                border-bottom: 1px solid #EDE6E6;
                min-height: 5rem;
            }
            .layer > div > div ul > li > div span{
                padding: 0 1.2rem;
                border: 1px solid #ddd;
                margin-right: 1.0rem;
                display: inline-block;
                margin-bottom: .6rem;
                -webkit-border-radius: .4rem;
                border-radius: .4rem;
            }
            .layer .second-layer{
                -webkit-transform: translateX(100%);
                position: absolute;
                top: 0;
                left: 20%;
                margin-left: 0;
                z-index: 2;
            }
            .layer .second-layer ul > li{
                height: 4rem;
                min-height: 4rem;
                line-height: 4rem;
            }
            .layer .second-layer .layer-iscroll{
                width: 100%;
                left: 0;
            }
            .layer.customer-filter ul > li{
                min-height: 4.0rem;
                line-height: 4.0rem;
                position: relative;
            }
            .layer.customer-filter ul > li > span{
                font-size: 2.4rem;
                float: right;
                line-height: 4rem;
                width: 4rem;
                color: rgb(190, 186, 186);
            }
            .layer.customer-filter ul > li > span:before{
                content: '';
                position: absolute;
                width: 1rem;
                height: 1rem;
                top: 1.4rem;
                right: 2rem;
                border-top: .2rem solid #CCCCCC;
                border-right: .2rem solid #CCCCCC;
                transform: rotate(45deg);
                -webkit-transform: rotate(45deg);
            }
            .layer-iscroll{
                position: absolute;
                width: 80%;
                top:5.0rem;left:20%;bottom:0;
                overflow: hidden;
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
                -webkit-text-size-adjust: none;
                -moz-text-size-adjust: none;
                -ms-text-size-adjust: none;
                -o-text-size-adjust: none;
                text-size-adjust: none;
            }
            input{
                height: 4rem;
                border: none;
                background-color: #FFFFFF;
                outline: none;
                font-size: 1.6rem;
                font-family: '微软雅黑';
            }
            #reg{
                position: absolute;
                width: 100%;
                top: 0;
                left: 0;
                bottom: 0;
                background-color: #f6f6f6;
                overflow: hidden;
            }
            #reg > header{
                width: 100%;
                height: 5rem;
                line-height: 5rem;
                background-color: #f9f9f9;
                display: table;
                table-layout: fixed;
                text-align: center;
                box-shadow: 0 .2rem .2rem 0 #E2E2E2;
            }
            #reg > header > span{
                display: table-cell;
            }
            #reg > header > span:first-child{
                width: 15%;
            }
            #reg > header > span:first-child > em{
                display: inline-block;
                width: 1rem;
                height: 1rem;
                border-left: .2rem solid #c2c2c2;
                border-bottom: .2rem solid #c2c2c2;
                -webkit-transform: rotate(45deg);
                transform: rotate(45deg);
            }
            #reg > header > span:nth-child(2){
                font-size: 2.0rem;
                color: #2e2e2e;
                text-indent: -15%;
            }
            #reg > div:nth-of-reg(1){
                height: 15rem;
                background: url(img/reg.jpg) no-repeat;
                background-size: cover;
            }
            #reg section{
                position: absolute;
                padding: 4% 3%;
                width: 94%;
                top: 5rem;
                left: 0;
                bottom: 0;
                color: #525252;
                overflow: auto;
                overflow-y: hidden;
            }
            #reg section .user-input{
                display: table;
                table-layout: fixed;
                text-align: center;
                width: 100%;
                height: 4.1rem;
                line-height: 4.1rem;
                border-radius: .4rem;
                background-color: #FFFFFF;
                margin-top: 1.6rem;
                font-size: 1.6rem;
            }
            #reg section > div.user-input:last-child{
                height: 5rem;
            }
            #reg section .user-input:nth-child(1){
                margin-top: 0;
            }
            #reg section .user-input > span{
                display: table-cell;border-radius: .4rem;
            }
            #reg section .user-input > span:nth-child(1){width: 25%;text-align: left;text-indent: .8rem;}
            #reg section .user-input.btn > span:nth-child(1){width: 100%;background-color: #e9e9e9;}
            #reg section .user-input.next-step > span:nth-child(1){width: 100%;background-color: #f78268;color: #FFFFFF;vertical-align: middle;}
            #reg section .user-input.go-login > span:nth-child(1){width: 100%;background-color: #68c8ef;color: #FFFFFF;vertical-align: middle;}
            #reg section .user-input > span:only-child{text-align: center;text-indent: 0;}
            #reg section .user-input > span:nth-child(2) > input{width: 100%;}
            #reg #first .user-input > span:nth-child(2){
                text-align: left;
            }
            #reg #first .user-input  #prefix + input{
                width: 60%;
                min-width: 40%;
            }
            .hint{
                margin-top: 3rem;
                text-align: center;
                color: #8b8b8b;
                line-height: 2.2rem;
            }
            .hint em,#last > div:nth-child(2) em{
                font-size: 1.8rem;
                color: #f78268;
            }
            section#last{
                background: #FFFFFF;
                top: 0;
            }
            #last > div:first-child{
                height: 15rem;
                background: url(../img/third_step.jpg) no-repeat;
                background-size: cover;
                margin: -4% -3%;
            }
            #last > div:nth-child(2){
                padding: 14% 3% 0;
                text-align: center;
                line-height: 2.2rem;
            }
            #last > div:nth-child(2) > p{
                text-align: justify;
            }
            #last .success > div{
                display: table;
                table-layout: fixed;
                width: 100%;
                padding-top: 2rem;
                line-height: 2.2rem;
            }
            #last .success > div > span{
                display: table-cell;
                color: #f78268;
                vertical-align: middle;
            }
            #last .success > div > span:nth-child(1){
                width: 30%;
                text-align: right;
            }
            #last .success > div > span:nth-child(2) > em{
                font-size: 2.0rem;
            }
            #last .success > div > span:nth-child(1) em{
                width: 5rem;
                height: 5rem;
                background-color: #f78268;
                border-radius: 50%;
                display: inline-block;
                margin-right: 1rem;
                position: relative;
            }
            /*#last .success > div > span:nth-child(1) em:before{
                content: '';
                position: absolute;
                width: 2.5rem;
                height: 1.5rem;
                margin: 1rem -4rem;
                border-left: .6rem solid #FFFFFF;
                border-bottom: .6rem solid #FFFFFF;
                -webkit-transform: rotate(315deg);
                transform: rotate(315deg);
            }*/
            #last .success > div > span:nth-child(1) em > span{
                position: absolute;
                width: 2.5rem;
                height: 1.5rem;
                top: 1rem;
                left: 1rem;
                border-left: .6rem solid #FFFFFF;
                border-bottom: .6rem solid #FFFFFF;
                -webkit-transform: rotate(315deg);
                transform: rotate(315deg);
            }
            #last .success > div:nth-child(2){
                text-align: center;
            }
            #last .success > div:nth-child(2) > p{
                display: table;
                table-layout: fixed;
                text-align: center;
                width: 100%;
            }
            #last .success > div:nth-child(2) > p > span,#last .success > div:nth-child(2) > p > em{
                display: table-cell;
            }
            #last .success > div:nth-child(2) > p > span{
                text-align: right;
            }
            em.under-line1{
                color: #5cb9a1;
                text-align: left;
                width: 60%;
            }
            em.under-line2{
                color: #68c8ef;
                text-align: left;
                width: 60%;
            }
            #msg{
                min-width: 10rem;
                max-width: 80%;
                text-align: center;
                border-radius: .5rem;
                background-color: rgba(0,0,0,.5);
                color: #FFFFFF;
                -webkit-box-sizing: border-box;
                box-sizing: border-box;
                position: absolute;
                z-index: 1000;
                top: 50%;
                left: 50%;
                transform: translate3d(-50%,-50%,0);
                -webkit-transform: translate3d(-50%,-50%,0);
                padding: .4rem 1rem;
                display: none;
            }
            #prefix{
                color: #BAAFAF;
            }
        </style>
    </head>
    <body>
        <div id="reg">
            <header>
                <span onclick="reg.goBack();"><em></em></span>
                <span id="title">账号信息</span>
            </header>
            <form action="" id="reg-form">
                <section id="first">
                    <div class="user-input">
                        <span>账号</span>
                        <span><em id="prefix"></em><input name="clientName" type="text" placeholder="3-12位英文字母或数字" /></span>
                    </div>
                    <div class="user-input">
                        <span>登录密码</span>
                        <span><input type="password" name="clientPassword" placeholder="3-18位英文字母或数字" /></span>
                    </div>
                    <div class="user-input">
                        <span>确认密码</span>
                        <span><input type="password" name="clientPassword2" placeholder="请与登录密码保持一致" /></span>
                    </div>
                    <div class="user-input">
                        <span>单位名称</span>
                        <span><input name="clientCompanyName" type="text" placeholder="请输入单位名称" /></span>
                    </div>
                    <div onclick="reg.checkStep();" class="user-input next-step">
                        <span>下一步</span>
                    </div>
                </section>
                <section id="second" style="display: none;">
                    <div id="area" class="user-input">
                        <span>地区</span>
                        <span>
                            <input name="clientAreaText" readonly type="text" placeholder="选择地区" />
                            <input name="clientArea" type="hidden" />
                        </span>
                    </div>
                    <div id="addr" class="user-input">
                        <span>地址</span>
                        <span><input name="clientAdd" type="text" placeholder="请输入地址" /></span>
                    </div>
                    <div class="user-input">
                        <span>联系人</span>
                        <span><input name="clientTrueName" type="text" placeholder="联系人" /></span>
                    </div>
                    <div class="user-input">
                        <span>手机</span>
                        <span><input name="clientMobile" type="text" placeholder="您的手机号码" /></span>
                    </div>
                    <div onclick="reg.saveReg();" class="user-input next-step">
                        <span>提交资料</span>
                    </div>
                </section>
            </form>
            <section id="last" style="display: none;">
                <div class="success">
                    <div>
                        <span><em><span></span></em></span>
                        <span><em>恭喜您</em><br>已经注册成功</span>
                    </div>
                    <div>
                        <p><span>您的账号：</span><em class="under-line1"></em></p>
                        <p><span>单位名称：</span><em class="under-line2"></em></p>
                    </div>
                </div>
                <div>
                    <p id="rel-msg"></p>
                </div>
                <div id="reg-success" class="user-input go-login">
                    <span onclick="javascript:window.location.href='../login.html'">现在去登录</span>
                </div>
            </section>
            <!-- 区域 -->
            <div id="area-layer" class="customer-filter layer">
                <div onclick="utils.stopPropagation();">
                    <h4>
                        <span onclick="reg.toggleLayer();" class="float-left">取消</span>
                        <span>所在地区</span>
                    </h4>
                    <div class="layer-iscroll">
                        <ul id="area-ul">
                            
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div id="msg"></div>
        <script src="../js/common/zepto.min.js" type="text/javascript"></script>
        <script src="../js/common/iscroll.js" type="text/javascript"></script>
        <script>
            // 工具对象
            var utils = (function(a){
                
                return {
                    // http://wy.dhb.net.cn/mobileApi/api.php  http://yaoliankeji.dhb.net.cn/mobileApi/api.php
                    url: 'http://yy.yitong111.com/mobileApi/api.php',
                    stopPropagation: function(e){
                        e = e || window.event;
                        e.stopPropagation();
                    }
                };
            }());
            var reg = {
                prefix: '',
                regInfo: null,
                showBlock: 1,// 1 2 3 
                layerState: 0,  //0 hide 1 show  
                checkUserName: function(val){
                    if(!val){
                        alert('请输入账号');
                        return;
                    }
                    //?f=getOnlyName&v={"onlyClientName":"rsung-seek"}
                    var params = {
                        f: 'getOnlyName',
                        v: JSON.stringify({
                            onlyClientName: this.prefix + val
                        })
                    };
                    $.ajax({
                        url: utils.url,
                        type: 'post',
                        dataType: 'json',
                        data: $.param(params),
                        success: function(data){
                            if(data && data.rStatus != 100){
                                alert('账号已存在，请更换其他账号');
                            }else{
                                reg.nextStep('first','second','基础信息');
                            }
                        }
                    });
                },
                // 检查当前步骤信息输入是否完整
                checkStep: function(){
                    var formArr = $('#reg-form').serializeArray();
                    if(!formArr[0].value || !formArr[1].value || !formArr[2].value || !formArr[3].value){
                        alert('信息输入不完整');
                        return;
                    }
                    if(!/^[a-zA-Z0-9]{3,12}$/.test(formArr[0].value)){
                        alert('请输入正确账号');
                        return;
                    }
                    if(!/^[a-zA-Z0-9]{3,18}$/.test(formArr[1].value)){
                        alert('请输入3-18位数字或字母组合的密码');
                        return;
                    }
                    if(formArr[1].value != formArr[2].value){
                        alert('密码输入不一致');
                        return;
                    }
                    this.checkUserName(formArr[0].value);
                    
                },
                // 
                saveReg: function(){
                    var formArr = $('#reg-form').serializeArray();
                    if(!formArr[4].value || !formArr[5].value || !formArr[7].value || !formArr[8].value){
                        alert('除地址外其他三项为必填项');
                        return;
                    }
                    if(!/^\d{11}$/.test(formArr[8].value)){
                        alert('请输入正确手机号码');
                        return;
                    }
                    var params = {
                        f: 'submitRegiesterClient',
                        v: JSON.stringify({
                            wid: wid,
                            clientName: formArr[0].value,
                            clientPassword: formArr[1].value,
                            clientCompanyName: formArr[3].value,
                            clientArea: formArr[5].value,
                            clientAdd: formArr[6].value,
                            clientTrueName: formArr[7].value,
                            clientMobile: formArr[8].value
                        })
                    };
                    var _this = this;
                    $.ajax({
                        url: utils.url,
                        type: 'post',
                        dataType: 'json',
                        data: $.param(params),
                        success: function(data){
                            if(data && data.rStatus == 100){
                                $('.under-line1').text(_this.prefix + formArr[0].value);
                                $('.under-line2').text(formArr[3].value);
                                $('#rel-msg').text(data.error);
                                if(data.isLogin != 'T'){ //Ｔ：可登录，Ｆ：不可登录
                                    $('#reg-success span').text('返回首页');
                                }
                                _this.nextStep('second','last','');
                            }
                            else{
                                $('#msg').text(data.error).show();
                                setTimeout(function(){
                                    $('#msg').hide();
                                },5000);
                            }
                        },
                        error: function(){
                            $('#msg').text('注册失败').show();
                            setTimeout(function(){
                                $('#msg').hide();
                            },5000);
                        }
                    });
                },
                // function nextStep and goBack 是未引入zepto的时候写的
                nextStep: function(from, to ,title){
                    /*if(title){
                        document.querySelector('#title').innerHTML = title;
                    }*/
                    if(to === 'last'){
                        this.showBlock = 3;
                        document.querySelector('#' + to).style.top = '0';
                    }
                    else if(to === 'second'){
                        this.showBlock = 2;
                    }
                    else if(to === 'first'){
                        this.showBlock = 1;
                    }
                    document.querySelector('#' + from).style.display = 'none';
                    document.querySelector('#' + to).style.display = 'block';
                    window.history.pushState({from: 'next'},null,location.href);
                },
                goBack: function(tag){
                    if(this.showBlock === 3){
                        this.showBlock = 2;
                        /*document.querySelector('#title').innerHTML = '基础信息';*/
                        document.querySelector('#last').style.display = 'none';
                        document.querySelector('#second').style.display = 'block';
                    }
                    else if(this.showBlock === 2){
                        this.showBlock = 1;
                        /*document.querySelector('#title').innerHTML = '账号信息';*/
                        document.querySelector('#second').style.display = 'none';
                        document.querySelector('#first').style.display = 'block';
                    }
                    if(!tag){
                        window.history.back();
                    }
                },
                toggleLayer: function(){
                    if(this.layerState === 0){
                        this.layerState = 1;
                        $('#area-layer').css('-webkit-transform','translate3d(-100%,0,0)');
                        return;
                    }
                    this.layerState = 0;
                    $('#area-layer').css('-webkit-transform','translate3d(0,0,0)');
                },
                // 获取注册信息 地区数据 系统名称等
                getRegInfo: function(){
                    if(this.regInfo) return;
                    
                    $('#msg').text('获取注册信息中...').show();
                    var params = {
                        f: 'getRegiester',
                        v: JSON.stringify({
                            wid: wid
                        })
                    };
                    var _this = this;
                    $.ajax({
                        url: utils.url,
                        type: 'post',
                        dataType: 'json',
                        data: $.param(params),
                        success: function(data){
                            if(data && data.rStatus == 100){
                                _this.regInfo = data;
                                _this.prefix = data.CompanyPrefix + '-';
                                $('#prefix').text(data.CompanyPrefix + '- ');
                                $('#title').text(data.CompanyName);
                                
                                if(data.CompanyName){
                                    var _body = $('body');
                                    document.title = data.CompanyName;
                                    // hack在微信等webview中无法修改document.title的情况
                                    var _iframe = $('<iframe src="/favicon.ico"></iframe>');
                                    _iframe.on('load',function() {
                                        setTimeout(function() {
                                            _iframe.off('load').remove();
                                        }, 0);
                                   
                                    }).appendTo(_body);
                                }
                                
                                _this.appenArea(0);
                                $('#msg').hide();
                            }
                            else{
                                $('#msg').text(data.error);
                                setTimeout(function(){
                                    $('#msg').hide();
                                },5000);
                            }
                        },
                        error: function(){
                            $('#msg').text('获取注册相关信息失败');
                            setTimeout(function(){
                                $('#msg').hide();
                            },5000);
                        }
                    });
                },
                appenArea: function(parentId,areaName){
                    var areaData = this.regInfo.rData;
                    var str = '';
                    for(var i = 0; i < areaData.length; i += 1){
                        if(areaData[i].ParentID == parentId){
                            str += '<li data-areaid="' + areaData[i].AreaID + '" data-areaname="' 
                            + areaData[i].AreaName + '" data-parentid="' + areaData[i].ParentID + '">' + areaData[i].AreaName
                            + '<span></span></li>';
                        }
                    }
                    if(str.length > 0){
                        $('#area-ul').html(str);
                    }
                    else{
                        $('#reg-form').find('input[name=clientAreaText]').val(areaName);
                        $('#reg-form').find('input[name=clientArea]').val(parentId);
                        this.toggleLayer();
                    }
                    
                }
            };
            
            // 加载注册信息
            reg.getRegInfo();
            
            window.onpopstate = function(e){
                /*if(e.state && e.state.from !== 'next') {
                    reg.showBlock = reg.showBlock === 3 ? reg.showBlock = 2 : (reg.showBlock === 2 ? reg.showBlock = 1 : 1);
                    return;
                };*/
                reg.goBack(true);
            };
            // 地区输入框点击
            $('#area').click(function(){
                if(!reg.regInfo){
                    reg.getRegInfo();
                }else{
                    reg.appenArea(0);
                }
                reg.toggleLayer();
                
            });
            
            // 区域点击事件
            $('#area-ul').on('click','li',function(e){
                reg.appenArea($(this).attr('data-areaid'),$(this).attr('data-areaname'));
            });
            
            // 弹出层点击
            $('#area-layer').click(function(e){
                utils.stopPropagation(e);
                reg.toggleLayer();
            });
            
            new iScroll($('div.layer-iscroll')[0],{ checkDOMChanges: true,mouseWheel: false ,hideScrollbar: true,
                fadeScrollbar: true,scrollbarClass: 'myScrollbar',
                onBeforeScrollStart: function (e) {
                    var target = e.target;
                    while (target.nodeType != 1) {
                        target = target.parentNode;
                    }
                    if (target.tagName.toUpperCase() != 'SELECT' && target.tagName.toUpperCase() != 'TEXTAREA' && target.tagName.toUpperCase() != 'INPUT') {
                        e.preventDefault();
                    }
                }
            });
        </script>
    </body>
</html>